---
import { SignedIn, SignedOut } from '@clerk/astro/components';
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a0a0f" />
    <title>Ordens de Servi√ßo - ScarTech Solutions</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; min-height: -webkit-fill-available; -webkit-tap-highlight-color: transparent; }
      html { height: -webkit-fill-available; }
      .layout { display: flex; min-height: 100vh; }
      .sidebar { width: 260px; background: linear-gradient(180deg, #0d0d12 0%, #12121a 100%); border-right: 1px solid rgba(0, 255, 255, 0.1); padding: 20px 0; display: flex; flex-direction: column; transition: width 0.3s ease; position: relative; }
      .sidebar.collapsed { width: 70px; }
      .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); display: flex; align-items: center; gap: 12px; }
      .sidebar.collapsed .sidebar-header { justify-content: center; padding: 0 10px 20px; }
      .logo-img { width: 40px; height: 40px; border-radius: 8px; }
      .logo-text { font-size: 1.2rem; font-weight: 700; color: #00ffff; white-space: nowrap; }
      .sidebar.collapsed .logo-text { display: none; }
      .toggle-btn { position: absolute; top: 20px; right: -15px; width: 30px; height: 30px; background: #1a1a2e; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #00ffff; transition: all 0.3s ease; z-index: 10; }
      .toggle-btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
      .hamburger { display: flex; flex-direction: column; gap: 3px; }
      .hamburger span { display: block; width: 14px; height: 2px; background: #00ffff; }
      .nav-section { padding: 20px 0; }
      .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #666; padding: 0 20px; margin-bottom: 10px; letter-spacing: 1px; }
      .sidebar.collapsed .nav-title { display: none; }
      .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #a0a0a0; text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; }
      .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 10px; }
      .nav-item:hover { background: rgba(0, 255, 255, 0.05); color: #00ffff; border-left-color: #00ffff; box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1); }
      .nav-item.active { background: rgba(0, 255, 255, 0.1); color: #00ffff; border-left-color: #00ffff; }
      .nav-icon { font-size: 1.2rem; width: 24px; text-align: center; }
      .nav-text { white-space: nowrap; }
      .sidebar.collapsed .nav-text { display: none; }
      .main-content { flex: 1; padding: 30px; overflow-y: auto; }
      .page-header { margin-bottom: 30px; }
      .page-title { font-size: 1.8rem; color: #fff; margin-bottom: 5px; }
      .page-subtitle { color: #666; }
      .card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
      .card-title { font-size: 1.2rem; color: #00ffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.05) 100%); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; font-size: 1rem; }
      .btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); transform: translateY(-2px); }
      .btn-primary { background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; border: none; }
      .btn-primary:hover { box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(0, 255, 255, 0.1); }
      th { color: #00ffff; font-weight: 600; }
      tr:hover { background: rgba(0, 255, 255, 0.05); }
      .status { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
      .status.aberta { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
      .status.concluida { background: rgba(0, 255, 0, 0.2); color: #00ff00; }
      .not-signed-in { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 20px; }
      .login-btn { padding: 12px 30px; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; }
      .empty-message { color: #666; text-align: center; padding: 20px; }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
      .modal.active { display: flex; }
      .modal-content { background: #12121a; border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 30px; width: 100%; max-width: 400px; }
      .modal-content h3 { color: #00ffff; margin-bottom: 20px; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; color: #a0a0a0; margin-bottom: 5px; font-size: 0.9rem; }
      .form-group input, .form-group select { width: 100%; padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 6px; color: #fff; font-size: 1rem; }
      .form-group input:focus, .form-group select:focus { outline: none; border-color: #00ffff; }
      .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
      .btn-delete { padding: 4px 8px; font-size: 0.8rem; background: rgba(255,100,100,0.2); border-color: rgba(255,100,100,0.3); color: #ff6b6b; }
      .btn-status { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; }
      .btn-view { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; background: rgba(0,150,255,0.2); border-color: rgba(0,150,255,0.3); color: #00aaff; }
      .btn-edit { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; background: rgba(255,200,0,0.2); border-color: rgba(255,200,0,0.3); color: #ffcc00; }
      .actions-cell { white-space: nowrap; }
      .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,255,255,0.1); }
      .detail-label { color: #888; }
      .detail-value { color: #fff; font-weight: 500; }

      /* Mobile Menu Button */
      .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; width: 45px; height: 45px; background: linear-gradient(135deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 12px; cursor: pointer; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
      .mobile-menu-btn span { display: block; width: 22px; height: 2px; background: #00ffff; transition: all 0.3s ease; }
      .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
      .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
      .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
      .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 999; }
      .sidebar-overlay.visible { display: block; }

      /* Mobile Responsivo */
      @media (max-width: 768px) {
        .mobile-menu-btn { display: flex; }
        .sidebar { position: fixed; left: 0; top: 0; height: 100vh; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease; width: 280px; }
        .sidebar.open { transform: translateX(0); }
        .toggle-btn { display: none; }
        .main-content { padding: 15px; }
        .page-title { font-size: 1.4rem; }
        .card { padding: 15px; }
        table { font-size: 0.85rem; }
        th, td { padding: 8px 6px; }
        .btn { padding: 10px 16px; font-size: 0.9rem; }
        .modal-content { margin: 15px; max-width: calc(100% - 30px); }
      }

      @media (max-width: 480px) {
        .main-content { padding: 10px; }
        table { display: block; overflow-x: auto; white-space: nowrap; }
        .form-group input, .form-group select { font-size: 16px; }
      }
    </style>
  </head>
  <body>
    <SignedOut>
      <div class="not-signed-in">
        <h2>Acesso Restrito</h2>
        <a href="/" class="login-btn">Fazer Login</a>
      </div>
    </SignedOut>

    <SignedIn>
      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span><span></span><span></span>
      </button>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <div class="layout">
        <aside class="sidebar" id="sidebar">
          <button class="toggle-btn" id="toggleBtn">
            <div class="hamburger"><span></span><span></span><span></span></div>
          </button>
          <div class="sidebar-header">
            <img src="/logo.png" alt="ScarTech" class="logo-img" />
            <span class="logo-text">ScarTech</span>
          </div>
          <nav class="nav-section">
            <div class="nav-title">Principal</div>
            <a href="/dashboard" class="nav-item"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a>
            <a href="/faturamento" class="nav-item"><span class="nav-icon">üí∞</span><span class="nav-text">Faturamento</span></a>
          </nav>
          <nav class="nav-section">
            <div class="nav-title">Gest√£o</div>
            <a href="/ordens" class="nav-item active"><span class="nav-icon">üìã</span><span class="nav-text">Ordens de Servi√ßo</span></a>
            <a href="/produtos" class="nav-item"><span class="nav-icon">üì¶</span><span class="nav-text">Produtos</span></a>
            <a href="/vendas" class="nav-item"><span class="nav-icon">üõí</span><span class="nav-text">Vendas</span></a>
          </nav>
        </aside>

        <main class="main-content">
          <div class="page-header">
            <h1 class="page-title">Ordens de Servi√ßo</h1>
            <p class="page-subtitle">Gerencie as ordens de servi√ßo</p>
          </div>

          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2 class="card-title" style="margin-bottom: 0;">üìã Lista de Ordens</h2>
              <a href="/ordem" class="btn btn-primary">+ Nova Ordem</a>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>N¬∫</th>
                  <th>Cliente</th>
                  <th>Equipamento</th>
                  <th>Status</th>
                  <th>Data</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="ordensBody">
                <tr><td colspan="6" class="empty-message">Nenhuma ordem de servi√ßo</td></tr>
              </tbody>
            </table>

            <!-- Modal Nova Ordem -->
            <div class="modal" id="modalOrdem">
              <div class="modal-content">
                <h3>Nova Ordem de Servi√ßo</h3>
                <form id="formOrdem">
                  <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="clienteOrdem" required />
                  </div>
                  <div class="form-group">
                    <label>Equipamento</label>
                    <input type="text" id="equipamentoOrdem" required />
                  </div>
                  <div class="form-group">
                    <label>Descri√ß√£o do Problema</label>
                    <input type="text" id="descricaoOrdem" required />
                  </div>
                  <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="valorOrdem" step="0.01" min="0" placeholder="0.00" />
                  </div>
                  <div class="modal-actions">
                    <button type="button" class="btn" onclick="window.fecharModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Modal Ver Detalhes -->
            <div class="modal" id="modalDetalhes">
              <div class="modal-content">
                <h3>üìã Detalhes da Ordem</h3>
                <div id="detalhesConteudo"></div>
                <div class="modal-actions">
                  <button type="button" class="btn" onclick="window.fecharDetalhes()">Fechar</button>
                </div>
              </div>
            </div>

            <!-- Modal Editar -->
            <div class="modal" id="modalEditar">
              <div class="modal-content">
                <h3>‚úèÔ∏è Editar Ordem</h3>
                <form id="formEditar">
                  <input type="hidden" id="editarIndex" />
                  <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="editarCliente" required />
                  </div>
                  <div class="form-group">
                    <label>Equipamento</label>
                    <input type="text" id="editarEquipamento" required />
                  </div>
                  <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="editarDescricao" required />
                  </div>
                  <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="editarValor" step="0.01" min="0" />
                  </div>
                  <div class="form-group">
                    <label>Status</label>
                    <select id="editarStatus">
                      <option value="aberta">Aberta</option>
                      <option value="concluida">Conclu√≠da</option>
                    </select>
                  </div>
                  <div class="modal-actions">
                    <button type="button" class="btn" onclick="window.fecharEditar()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                  </div>
                </form>
              </div>
            </div>

            <a href="/dashboard" class="btn" style="margin-top: 20px;">‚Üê Voltar</a>
          </div>
        </main>
      </div>
    </SignedIn>

    <script is:inline>
      document.getElementById('toggleBtn')?.addEventListener('click', () => {
        document.getElementById('sidebar')?.classList.toggle('collapsed');
      });

      let ordens = JSON.parse(localStorage.getItem('scartech_ordens') || '[]');
      
      function renderOrdens() {
        const tbody = document.getElementById('ordensBody');
        if (ordens.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-message">Nenhuma ordem de servi√ßo</td></tr>';
        } else {
          tbody.innerHTML = ordens.map((o, i) => `
            <tr>
              <td>#${o.numOS || String(i + 1).padStart(3, '0')}</td>
              <td>${o.cliente || '-'}</td>
              <td>${o.equipamento || '-'}</td>
              <td><span class="status ${o.status}">${o.status === 'aberta' ? 'Aberta' : 'Conclu√≠da'}</span></td>
              <td>${o.data || '-'}</td>
              <td class="actions-cell">
                <button class="btn btn-view" onclick="window.verDetalhes(${i})" title="Ver Detalhes">üëÅÔ∏è</button>
                <button class="btn btn-edit" onclick="window.editarOrdem(${i})" title="Editar">‚úèÔ∏è</button>
                <button class="btn btn-status" onclick="window.alterarStatus(${i})" title="${o.status === 'aberta' ? 'Concluir' : 'Reabrir'}">${o.status === 'aberta' ? '‚úì' : '‚Ü©'}</button>
                <button class="btn btn-delete" onclick="window.excluirOrdem(${i})" title="Excluir">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('');
        }
      }

      window.abrirModal = function() {
        document.getElementById('modalOrdem').classList.add('active');
      };

      window.fecharModal = function() {
        document.getElementById('modalOrdem').classList.remove('active');
        document.getElementById('formOrdem').reset();
      };

      window.verDetalhes = function(index) {
        const o = ordens[index];
        const conteudo = document.getElementById('detalhesConteudo');
        conteudo.innerHTML = `
          <div class="detail-row">
            <span class="detail-label">N¬∫ OS:</span>
            <span class="detail-value">#${o.numOS || String(index + 1).padStart(3, '0')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Cliente:</span>
            <span class="detail-value">${o.cliente || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Equipamento:</span>
            <span class="detail-value">${o.equipamento || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Descri√ß√£o:</span>
            <span class="detail-value">${o.descricao || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Valor:</span>
            <span class="detail-value">R$ ${o.valor ? parseFloat(o.valor).toFixed(2) : '0.00'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value"><span class="status ${o.status}">${o.status === 'aberta' ? 'Aberta' : 'Conclu√≠da'}</span></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Data:</span>
            <span class="detail-value">${o.data || '-'}</span>
          </div>
        `;
        document.getElementById('modalDetalhes').classList.add('active');
      };

      window.fecharDetalhes = function() {
        document.getElementById('modalDetalhes').classList.remove('active');
      };

      window.editarOrdem = function(index) {
        const o = ordens[index];
        document.getElementById('editarIndex').value = index;
        document.getElementById('editarCliente').value = o.cliente || '';
        document.getElementById('editarEquipamento').value = o.equipamento || '';
        document.getElementById('editarDescricao').value = o.descricao || '';
        document.getElementById('editarValor').value = o.valor || '';
        document.getElementById('editarStatus').value = o.status || 'aberta';
        document.getElementById('modalEditar').classList.add('active');
      };

      window.fecharEditar = function() {
        document.getElementById('modalEditar').classList.remove('active');
        document.getElementById('formEditar').reset();
      };

      window.alterarStatus = function(index) {
        ordens[index].status = ordens[index].status === 'aberta' ? 'concluida' : 'aberta';
        localStorage.setItem('scartech_ordens', JSON.stringify(ordens));
        renderOrdens();
        
        const msg = ordens[index].status === 'concluida' ? '‚úÖ Ordem conclu√≠da!' : 'üîÑ Ordem reaberta!';
        alert(msg);
      };

      window.excluirOrdem = function(index) {
        if (confirm('Tem certeza que deseja excluir esta ordem?')) {
          ordens.splice(index, 1);
          localStorage.setItem('scartech_ordens', JSON.stringify(ordens));
          renderOrdens();
          alert('üóëÔ∏è Ordem exclu√≠da com sucesso!');
        }
      };

      document.getElementById('formOrdem')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const ordem = {
          cliente: document.getElementById('clienteOrdem').value,
          equipamento: document.getElementById('equipamentoOrdem').value,
          descricao: document.getElementById('descricaoOrdem').value,
          valor: document.getElementById('valorOrdem').value || 0,
          status: 'aberta',
          data: new Date().toLocaleDateString('pt-BR'),
          numOS: Date.now().toString().slice(-6)
        };
        ordens.push(ordem);
        localStorage.setItem('scartech_ordens', JSON.stringify(ordens));
        window.fecharModal();
        renderOrdens();
        alert('‚úÖ Ordem criada com sucesso!');
      });

      document.getElementById('formEditar')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const index = parseInt(document.getElementById('editarIndex').value);
        ordens[index].cliente = document.getElementById('editarCliente').value;
        ordens[index].equipamento = document.getElementById('editarEquipamento').value;
        ordens[index].descricao = document.getElementById('editarDescricao').value;
        ordens[index].valor = document.getElementById('editarValor').value || 0;
        ordens[index].status = document.getElementById('editarStatus').value;
        localStorage.setItem('scartech_ordens', JSON.stringify(ordens));
        window.fecharEditar();
        renderOrdens();
        alert('‚úÖ Ordem atualizada com sucesso!');
      });

      // Fechar modais ao clicar fora
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });

      // Mobile Menu Toggle
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      
      function toggleMobileMenu() {
        mobileMenuBtn?.classList.toggle('active');
        sidebar?.classList.toggle('open');
        sidebarOverlay?.classList.toggle('visible');
      }
      
      mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
      sidebarOverlay?.addEventListener('click', toggleMobileMenu);

      renderOrdens();
    </script>
  </body>
</html>
