---
import { SignedIn, SignedOut } from '@clerk/astro/components';
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relat√≥rios - ScarTech Solutions</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; }
      .layout { display: flex; min-height: 100vh; }
      .sidebar { width: 260px; background: linear-gradient(180deg, #0d0d12 0%, #12121a 100%); border-right: 1px solid rgba(0, 255, 255, 0.1); padding: 20px 0; display: flex; flex-direction: column; transition: width 0.3s ease; position: relative; }
      .sidebar.collapsed { width: 70px; }
      .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); display: flex; align-items: center; gap: 12px; }
      .sidebar.collapsed .sidebar-header { justify-content: center; padding: 0 10px 20px; }
      .logo-img { width: 40px; height: 40px; border-radius: 8px; }
      .logo-text { font-size: 1.2rem; font-weight: 700; color: #00ffff; white-space: nowrap; }
      .sidebar.collapsed .logo-text { display: none; }
      .toggle-btn { position: absolute; top: 20px; right: -15px; width: 30px; height: 30px; background: #1a1a2e; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #00ffff; transition: all 0.3s ease; z-index: 10; }
      .toggle-btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
      .hamburger { display: flex; flex-direction: column; gap: 3px; }
      .hamburger span { display: block; width: 14px; height: 2px; background: #00ffff; }
      .nav-section { padding: 20px 0; }
      .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #666; padding: 0 20px; margin-bottom: 10px; letter-spacing: 1px; }
      .sidebar.collapsed .nav-title { display: none; }
      .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #a0a0a0; text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; }
      .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 10px; }
      .nav-item:hover { background: rgba(0, 255, 255, 0.05); color: #00ffff; border-left-color: #00ffff; box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1); }
      .nav-item.active { background: rgba(0, 255, 255, 0.1); color: #00ffff; border-left-color: #00ffff; }
      .nav-icon { font-size: 1.2rem; width: 24px; text-align: center; }
      .nav-text { white-space: nowrap; }
      .sidebar.collapsed .nav-text { display: none; }
      .main-content { flex: 1; padding: 30px; overflow-y: auto; }
      .page-header { margin-bottom: 30px; }
      .page-title { font-size: 1.8rem; color: #fff; margin-bottom: 5px; }
      .page-subtitle { color: #666; }
      
      /* Cards de resumo */
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .stat-card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 20px; }
      .stat-card.green { border-color: rgba(0, 255, 136, 0.3); }
      .stat-card.blue { border-color: rgba(0, 136, 255, 0.3); }
      .stat-card.purple { border-color: rgba(136, 0, 255, 0.3); }
      .stat-card.orange { border-color: rgba(255, 136, 0, 0.3); }
      .stat-icon { font-size: 2rem; margin-bottom: 10px; }
      .stat-value { font-size: 1.8rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
      .stat-label { font-size: 0.85rem; color: #666; }
      .stat-card.green .stat-value { color: #00ff88; }
      .stat-card.blue .stat-value { color: #00d4ff; }
      .stat-card.purple .stat-value { color: #aa88ff; }
      .stat-card.orange .stat-value { color: #ffaa00; }

      /* Gr√°ficos */
      .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .chart-card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 25px; }
      .chart-title { font-size: 1.1rem; color: #00ffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
      .chart-container { position: relative; height: 300px; }

      /* Tabela */
      .table-card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 25px; }
      .table-title { font-size: 1.1rem; color: #00ffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(0, 255, 255, 0.1); }
      th { color: #00ffff; font-weight: 600; font-size: 0.9rem; }
      tr:hover { background: rgba(0, 255, 255, 0.05); }
      .trend-up { color: #00ff88; }
      .trend-down { color: #ff6b6b; }

      /* Filtros */
      .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
      .filter-group { display: flex; flex-direction: column; gap: 5px; }
      .filter-group label { font-size: 0.8rem; color: #666; }
      .filter-group select, .filter-group input { padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 6px; color: #fff; font-size: 0.9rem; }
      .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #00ffff; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.05) 100%); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; font-size: 0.9rem; }
      .btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
      .btn-primary { background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; border: none; font-weight: 600; }

      .not-signed-in { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 20px; }
      .login-btn { padding: 12px 30px; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; }

      @media (max-width: 768px) {
        .charts-grid { grid-template-columns: 1fr; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
      }
    </style>
  </head>
  <body>
    <SignedOut>
      <div class="not-signed-in">
        <h2>Acesso Restrito</h2>
        <a href="/" class="login-btn">Fazer Login</a>
      </div>
    </SignedOut>

    <SignedIn>
      <div class="layout">
        <aside class="sidebar" id="sidebar">
          <button class="toggle-btn" id="toggleBtn">
            <div class="hamburger"><span></span><span></span><span></span></div>
          </button>
          <div class="sidebar-header">
            <img src="/logo.png" alt="ScarTech" class="logo-img" />
            <span class="logo-text">ScarTech</span>
          </div>
          <nav class="nav-section">
            <div class="nav-title">Principal</div>
            <a href="/dashboard" class="nav-item"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a>
            <a href="/faturamento" class="nav-item"><span class="nav-icon">üí∞</span><span class="nav-text">Faturamento</span></a>
          </nav>
          <nav class="nav-section">
            <div class="nav-title">Gest√£o</div>
            <a href="/ordens" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Ordens de Servi√ßo</span></a>
            <a href="/produtos" class="nav-item"><span class="nav-icon">üì¶</span><span class="nav-text">Produtos</span></a>
            <a href="/vendas" class="nav-item"><span class="nav-icon">üõí</span><span class="nav-text">Vendas</span></a>
          </nav>
          <nav class="nav-section">
            <div class="nav-title">Relat√≥rios</div>
            <a href="/relatorios" class="nav-item active"><span class="nav-icon">üìä</span><span class="nav-text">Relat√≥rios</span></a>
          </nav>
        </aside>

        <main class="main-content">
          <div class="page-header">
            <h1 class="page-title">üìä Relat√≥rios e An√°lises</h1>
            <p class="page-subtitle">Visualize o desempenho do seu neg√≥cio</p>
          </div>

          <!-- Filtros -->
          <div class="filters">
            <div class="filter-group">
              <label>Per√≠odo</label>
              <select id="periodoFiltro">
                <option value="7">√öltimos 7 dias</option>
                <option value="30" selected>√öltimos 30 dias</option>
                <option value="90">√öltimos 90 dias</option>
                <option value="365">√öltimo ano</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Tipo</label>
              <select id="tipoFiltro">
                <option value="todos">Todos</option>
                <option value="servicos">Servi√ßos</option>
                <option value="produtos">Produtos</option>
              </select>
            </div>
            <div class="filter-group" style="justify-content: flex-end;">
              <label>&nbsp;</label>
              <button class="btn" onclick="window.atualizarRelatorios()">üîÑ Atualizar</button>
            </div>
          </div>

          <!-- Cards de Estat√≠sticas -->
          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-icon">üí∞</div>
              <div class="stat-value" id="totalFaturamento">R$ 0,00</div>
              <div class="stat-label">Faturamento Total</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-icon">üìã</div>
              <div class="stat-value" id="totalOrdens">0</div>
              <div class="stat-label">Ordens de Servi√ßo</div>
            </div>
            <div class="stat-card purple">
              <div class="stat-icon">üõí</div>
              <div class="stat-value" id="totalVendas">0</div>
              <div class="stat-label">Vendas Realizadas</div>
            </div>
            <div class="stat-card orange">
              <div class="stat-icon">üìà</div>
              <div class="stat-value" id="ticketMedio">R$ 0,00</div>
              <div class="stat-label">Ticket M√©dio</div>
            </div>
          </div>

          <!-- Gr√°ficos -->
          <div class="charts-grid">
            <div class="chart-card">
              <h3 class="chart-title">üìà Faturamento Mensal</h3>
              <div class="chart-container">
                <canvas id="chartFaturamento"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 class="chart-title">ü•ß Distribui√ß√£o por Categoria</h3>
              <div class="chart-container">
                <canvas id="chartCategoria"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 class="chart-title">üìä Ordens por Status</h3>
              <div class="chart-container">
                <canvas id="chartStatus"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 class="chart-title">üìÖ Servi√ßos por Dia da Semana</h3>
              <div class="chart-container">
                <canvas id="chartDiaSemana"></canvas>
              </div>
            </div>
          </div>

          <!-- Tabela de Top Servi√ßos -->
          <div class="table-card">
            <h3 class="table-title">üèÜ Top Servi√ßos Mais Realizados</h3>
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Tipo de Servi√ßo</th>
                  <th>Quantidade</th>
                  <th>Receita Total</th>
                  <th>Tend√™ncia</th>
                </tr>
              </thead>
              <tbody id="topServicos">
                <tr>
                  <td>1</td>
                  <td>Troca de Tela</td>
                  <td>45</td>
                  <td>R$ 8.550,00</td>
                  <td class="trend-up">‚Üë 12%</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>Troca de Bateria</td>
                  <td>38</td>
                  <td>R$ 4.180,00</td>
                  <td class="trend-up">‚Üë 8%</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>Reparo Placa</td>
                  <td>22</td>
                  <td>R$ 6.600,00</td>
                  <td class="trend-down">‚Üì 3%</td>
                </tr>
                <tr>
                  <td>4</td>
                  <td>Troca de Conector</td>
                  <td>18</td>
                  <td>R$ 1.620,00</td>
                  <td class="trend-up">‚Üë 15%</td>
                </tr>
                <tr>
                  <td>5</td>
                  <td>Limpeza/Manuten√ß√£o</td>
                  <td>15</td>
                  <td>R$ 750,00</td>
                  <td class="trend-up">‚Üë 5%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </main>
      </div>
    </SignedIn>

    <script is:inline>
      // Toggle sidebar
      document.getElementById('toggleBtn')?.addEventListener('click', () => {
        document.getElementById('sidebar')?.classList.toggle('collapsed');
      });

      // Cores do tema
      const cores = {
        cyan: '#00ffff',
        cyanTransp: 'rgba(0, 255, 255, 0.2)',
        green: '#00ff88',
        greenTransp: 'rgba(0, 255, 136, 0.2)',
        purple: '#aa88ff',
        purpleTransp: 'rgba(170, 136, 255, 0.2)',
        orange: '#ffaa00',
        orangeTransp: 'rgba(255, 170, 0, 0.2)',
        red: '#ff6b6b',
        redTransp: 'rgba(255, 107, 107, 0.2)',
        blue: '#00d4ff',
        blueTransp: 'rgba(0, 212, 255, 0.2)'
      };

      // Configura√ß√£o global do Chart.js
      Chart.defaults.color = '#a0a0a0';
      Chart.defaults.borderColor = 'rgba(0, 255, 255, 0.1)';

      // Carregar dados do localStorage
      function carregarDados() {
        const ordens = JSON.parse(localStorage.getItem('scartech_ordens') || '[]');
        const vendas = JSON.parse(localStorage.getItem('scartech_vendas') || '[]');
        const produtos = JSON.parse(localStorage.getItem('scartech_produtos') || '[]');
        
        // Calcular estat√≠sticas
        const totalOrdens = ordens.length;
        const totalVendas = vendas.length;
        
        const faturamentoOrdens = ordens.reduce((sum, o) => sum + (parseFloat(o.valor) || 0), 0);
        const faturamentoVendas = vendas.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0);
        const totalFaturamento = faturamentoOrdens + faturamentoVendas;
        
        const totalTransacoes = totalOrdens + totalVendas;
        const ticketMedio = totalTransacoes > 0 ? totalFaturamento / totalTransacoes : 0;

        // Atualizar cards
        document.getElementById('totalFaturamento').textContent = `R$ ${totalFaturamento.toFixed(2).replace('.', ',')}`;
        document.getElementById('totalOrdens').textContent = totalOrdens;
        document.getElementById('totalVendas').textContent = totalVendas;
        document.getElementById('ticketMedio').textContent = `R$ ${ticketMedio.toFixed(2).replace('.', ',')}`;

        return { ordens, vendas, produtos, totalFaturamento, faturamentoOrdens, faturamentoVendas };
      }

      // Gr√°fico de Faturamento Mensal
      let chartFaturamento = null;
      function criarGraficoFaturamento(dados) {
        const ctx = document.getElementById('chartFaturamento').getContext('2d');
        
        if (chartFaturamento) chartFaturamento.destroy();

        // Simular dados mensais (baseado nos dados reais + simula√ß√£o)
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const mesAtual = new Date().getMonth();
        const dadosMensais = meses.map((_, i) => {
          if (i === mesAtual) return dados.totalFaturamento;
          if (i === mesAtual - 1) return dados.totalFaturamento * 0.85;
          if (i === mesAtual - 2) return dados.totalFaturamento * 0.72;
          return Math.random() * dados.totalFaturamento * 0.5 + 500;
        });

        chartFaturamento = new Chart(ctx, {
          type: 'line',
          data: {
            labels: meses,
            datasets: [{
              label: 'Faturamento (R$)',
              data: dadosMensais,
              borderColor: cores.cyan,
              backgroundColor: cores.cyanTransp,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: cores.cyan,
              pointBorderColor: '#0a0a0f',
              pointBorderWidth: 2,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 255, 255, 0.05)' },
                ticks: { callback: (value) => 'R$ ' + value.toFixed(0) }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }

      // Gr√°fico de Distribui√ß√£o por Categoria
      let chartCategoria = null;
      function criarGraficoCategoria(dados) {
        const ctx = document.getElementById('chartCategoria').getContext('2d');
        
        if (chartCategoria) chartCategoria.destroy();

        chartCategoria = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Servi√ßos (OS)', 'Vendas de Produtos', 'Acess√≥rios'],
            datasets: [{
              data: [
                dados.faturamentoOrdens || 1500, 
                dados.faturamentoVendas || 800, 
                Math.random() * 500 + 200
              ],
              backgroundColor: [cores.cyan, cores.green, cores.purple],
              borderColor: '#0a0a0f',
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
              }
            }
          }
        });
      }

      // Gr√°fico de Ordens por Status
      let chartStatus = null;
      function criarGraficoStatus(dados) {
        const ctx = document.getElementById('chartStatus').getContext('2d');
        
        if (chartStatus) chartStatus.destroy();

        const abertas = dados.ordens.filter(o => o.status === 'aberta').length || 3;
        const concluidas = dados.ordens.filter(o => o.status === 'concluida').length || 5;
        const emAndamento = dados.ordens.length - abertas - concluidas || 2;

        chartStatus = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Abertas', 'Em Andamento', 'Conclu√≠das'],
            datasets: [{
              label: 'Quantidade',
              data: [abertas, Math.max(emAndamento, 1), concluidas],
              backgroundColor: [cores.orangeTransp, cores.blueTransp, cores.greenTransp],
              borderColor: [cores.orange, cores.blue, cores.green],
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 255, 255, 0.05)' },
                ticks: { stepSize: 1 }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }

      // Gr√°fico de Servi√ßos por Dia da Semana
      let chartDiaSemana = null;
      function criarGraficoDiaSemana() {
        const ctx = document.getElementById('chartDiaSemana').getContext('2d');
        
        if (chartDiaSemana) chartDiaSemana.destroy();

        chartDiaSemana = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'],
            datasets: [{
              label: 'Servi√ßos',
              data: [2, 8, 12, 10, 14, 11, 5],
              backgroundColor: cores.purpleTransp,
              borderColor: cores.purple,
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 255, 255, 0.05)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }

      // Fun√ß√£o para atualizar todos os relat√≥rios
      window.atualizarRelatorios = function() {
        const dados = carregarDados();
        criarGraficoFaturamento(dados);
        criarGraficoCategoria(dados);
        criarGraficoStatus(dados);
        criarGraficoDiaSemana();
      };

      // Inicializar gr√°ficos quando a p√°gina carregar
      document.addEventListener('DOMContentLoaded', () => {
        window.atualizarRelatorios();
      });

      // Tamb√©m inicializar imediatamente caso DOMContentLoaded j√° tenha passado
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(() => window.atualizarRelatorios(), 100);
      }
    </script>
  </body>
</html>
