---
import { SignedIn, SignedOut } from "@clerk/astro/components";
---

<html lang="pt-BR" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a0a0f" />
    <title>Nova Ordem de Servi√ßo - ScarTech Solutions</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <script src="/js/scartech-cloud.js" is:inline></script>
    <script
      is:inline
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    ></script>
    <style>
      /* CSS Variables para Temas */
      :root {
        --bg-primary: #0a0a0f;
        --bg-secondary: #12121a;
        --bg-card: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%);
        --bg-sidebar: linear-gradient(180deg, #0d0d12 0%, #12121a 100%);
        --bg-header: linear-gradient(180deg, rgba(10, 10, 15, 0.95), rgba(10, 10, 15, 0.8));
        --bg-input: #1a1a2e;
        --text-primary: #ffffff;
        --text-secondary: #e0e0e0;
        --text-muted: #6b7280;
        --border-color: rgba(0, 255, 255, 0.1);
        --accent-color: #00ffff;
        --accent-secondary: #00ff88;
        --card-border: rgba(0, 255, 255, 0.1);
        --overlay-bg: rgba(0, 0, 0, 0.7);
        --shadow-color: rgba(0, 212, 255, 0.2);
        --success-color: #00ff88;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
      }

      [data-theme="light"] {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-card: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
        --bg-sidebar: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
        --bg-header: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(245, 245, 245, 0.9));
        --bg-input: #f0f0f0;
        --text-primary: #1a1a2e;
        --text-secondary: #4a4a5a;
        --text-muted: #6b7280;
        --border-color: rgba(0, 150, 200, 0.2);
        --accent-color: #0088aa;
        --accent-secondary: #00aa66;
        --card-border: rgba(0, 150, 200, 0.2);
        --overlay-bg: rgba(255, 255, 255, 0.9);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --success-color: #00aa66;
        --warning-color: #d97706;
        --danger-color: #dc2626;
      }

      /* Theme Toggle Button */
      .theme-toggle {
        position: fixed;
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px var(--shadow-color);
      }
      .theme-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 20px var(--shadow-color);
      }
      .theme-icon {
        font-size: 1.3rem;
        line-height: 1;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg-primary);
        color: var(--text-secondary);
        min-height: 100vh;
        min-height: -webkit-fill-available;
        -webkit-tap-highlight-color: transparent;
        transition: background 0.3s ease, color 0.3s ease;
      }
      html {
        height: -webkit-fill-available;
      }
      .layout {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease, background 0.3s ease;
        position: relative;
      }
      .sidebar.collapsed {
        width: 70px;
      }
      .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .sidebar.collapsed .sidebar-header {
        justify-content: center;
        padding: 0 10px 20px;
      }
      .logo-img {
        width: 40px;
        height: 40px;
        border-radius: 8px;
      }
      .logo-text {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--accent-color);
        white-space: nowrap;
      }
      .sidebar.collapsed .logo-text {
        display: none;
      }
      .toggle-btn {
        position: absolute;
        top: 20px;
        right: -15px;
        width: 30px;
        height: 30px;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-color);
        transition: all 0.3s ease;
        z-index: 10;
      }
      .toggle-btn:hover {
        background: rgba(0, 255, 255, 0.2);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      }
      .hamburger {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .hamburger span {
        display: block;
        width: 14px;
        height: 2px;
        background: var(--accent-color);
      }
      .nav-section {
        padding: 20px 0;
      }
      .nav-title {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #666;
        padding: 0 20px;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }
      .sidebar.collapsed .nav-title {
        display: none;
      }
      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #a0a0a0;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }
      .sidebar.collapsed .nav-item {
        justify-content: center;
        padding: 12px 10px;
      }
      .nav-item:hover {
        background: rgba(0, 255, 255, 0.05);
        color: #00ffff;
        border-left-color: #00ffff;
        box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1);
      }
      .nav-item.active {
        background: rgba(0, 255, 255, 0.1);
        color: #00ffff;
        border-left-color: #00ffff;
      }
      .nav-icon {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
      }
      .nav-text {
        white-space: nowrap;
      }
      .sidebar.collapsed .nav-text {
        display: none;
      }
      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
      }
      .page-header {
        margin-bottom: 30px;
      }
      .page-title {
        font-size: 1.8rem;
        color: var(--text-primary);
        margin-bottom: 5px;
      }
      .page-subtitle {
        color: #666;
      }
      .card {
        background: var(--bg-card);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 30px;
        transition: background 0.3s ease;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .form-group.full {
        grid-column: 1 / -1;
      }
      .form-group label {
        color: #a0a0a0;
        font-size: 0.9rem;
      }
      .form-group label span {
        color: #00ffff;
      }
      .form-group input,
      .form-group textarea {
        padding: 12px 15px;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 10px var(--shadow-color);
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      /* Upload de foto */
      .photo-upload-area {
        border: 2px dashed rgba(0, 255, 255, 0.3);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 0, 0, 0.2);
      }
      .photo-upload-area:hover {
        border-color: #00ffff;
        background: rgba(0, 255, 255, 0.05);
      }
      .photo-upload-area.has-image {
        padding: 10px;
      }
      .photo-upload-area input[type="file"] {
        display: none;
      }
      .photo-upload-icon {
        font-size: 3rem;
        margin-bottom: 10px;
      }
      .photo-upload-text {
        color: #a0a0a0;
        font-size: 0.9rem;
      }
      .photo-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        display: none;
      }
      .photo-preview.visible {
        display: block;
        margin: 0 auto;
      }
      .photo-actions {
        margin-top: 10px;
        display: none;
      }
      .photo-actions.visible {
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .btn-small {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      /* √Årea de assinatura digital */
      .signature-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
      }
      .signature-section h3 {
        color: var(--accent-color);
        font-size: 1.1rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .signatures-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }
      .signature-pad-container {
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
      }
      .signature-pad-container label {
        display: block;
        color: #a0a0a0;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }
      .signature-canvas {
        width: 100%;
        height: 150px;
        background: #fff;
        border-radius: 8px;
        cursor: crosshair;
        touch-action: none;
      }
      .signature-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
      }

      .signatures {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px dashed var(--border-color);
      }
      .signature-box {
        text-align: center;
      }
      .signature-box span {
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .signature-line {
        margin-top: 40px;
        border-bottom: 1px solid var(--accent-color);
      }

      .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(
          135deg,
          rgba(0, 255, 255, 0.1) 0%,
          rgba(0, 255, 255, 0.05) 100%
        );
        border: 1px solid var(--border-color);
        color: var(--accent-color);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn:hover {
        background: rgba(0, 255, 255, 0.2);
        box-shadow: 0 0 20px var(--shadow-color);
        transform: translateY(-2px);
      }
      .btn-primary {
        background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
        color: #000;
        border: none;
        font-weight: 600;
      }
      .btn-primary:hover {
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      }

      #pdfResult {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        display: none;
      }
      #pdfResult.success {
        background: rgba(0, 255, 0, 0.1);
        color: #00ff88;
        display: block;
      }
      #pdfResult.error {
        background: rgba(255, 0, 0, 0.1);
        color: #ff6b6b;
        display: block;
      }
      #pdfResult.loading {
        background: rgba(0, 255, 255, 0.1);
        color: #00ffff;
        display: block;
      }

      .not-signed-in {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        flex-direction: column;
        gap: 20px;
      }
      .login-btn {
        padding: 12px 30px;
        background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
        color: #000;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
      }

      /* Mobile Menu Button */
      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        width: 45px;
        height: 45px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .mobile-menu-btn span {
        display: block;
        width: 22px;
        height: 2px;
        background: var(--accent-color);
        transition: all 0.3s ease;
      }
      .mobile-menu-btn.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      .mobile-menu-btn.active span:nth-child(2) {
        opacity: 0;
      }
      .mobile-menu-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translate(5px, -5px);
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: var(--overlay-bg);
        backdrop-filter: blur(4px);
        z-index: 999;
      }
      .sidebar-overlay.visible {
        display: block;
      }

      /* Mobile Responsivo */
      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: flex;
        }
        .page-header {
          padding-left: 55px;
        }
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          z-index: 1000;
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          width: 280px;
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .toggle-btn {
          display: none;
        }
        .main-content {
          padding: 15px;
          padding-top: 70px;
        }
        .page-title {
          font-size: 1.4rem;
        }
        .card {
          padding: 20px;
        }
        .form-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        .signatures-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        .signature-canvas {
          height: 120px;
        }
        .form-actions {
          flex-direction: column;
        }
        .form-actions .btn {
          width: 100%;
          justify-content: center;
        }
        .photo-upload-area {
          padding: 20px;
        }
        .photo-upload-icon {
          font-size: 2rem;
        }
      }

      @media (max-width: 480px) {
        .main-content {
          padding: 10px;
          padding-top: 70px;
        }
        .page-header {
          margin-bottom: 15px;
        }
        .page-title {
          font-size: 1.2rem;
        }
        .page-subtitle {
          font-size: 0.8rem;
        }
        .card {
          padding: 12px;
          border-radius: 10px;
        }
        .card-title {
          font-size: 1rem;
          margin-bottom: 15px;
        }
        .form-group {
          margin-bottom: 12px;
        }
        .form-group label {
          font-size: 0.85rem;
          margin-bottom: 4px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
          padding: 12px;
          font-size: 16px; /* Previne zoom no iOS */
        }
        .btn {
          padding: 12px 16px;
          font-size: 0.9rem;
        }
        .signature-section h3 {
          font-size: 1rem;
        }
        .signature-canvas {
          height: 100px;
        }
        .photo-upload-area {
          padding: 15px;
        }
        .photo-upload-icon {
          font-size: 1.8rem;
        }
        .photo-upload-text {
          font-size: 0.85rem;
        }
        .form-actions {
          gap: 10px;
          margin-top: 20px;
        }
      }
    </style>
  </head>
  <body>
    <SignedOut>
      <div class="not-signed-in">
        <h2>Acesso Restrito</h2>
        <a href="/" class="login-btn">Fazer Login</a>
      </div>
    </SignedOut>

    <SignedIn>
      <!-- Theme Toggle Button -->
      <button class="theme-toggle" id="themeToggle" title="Alternar tema">
        <span class="theme-icon">üåô</span>
      </button>

      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span><span></span><span></span>
      </button>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <div class="layout">
        <aside class="sidebar" id="sidebar">
          <button class="toggle-btn" id="toggleBtn">
            <div class="hamburger"><span></span><span></span><span></span></div>
          </button>
          <div class="sidebar-header">
            <img src="/logo.png" alt="ScarTech" class="logo-img" />
            <span class="logo-text">ScarTech</span>
          </div>
          <nav class="nav-section">
            <div class="nav-title">Principal</div>
            <a href="/dashboard" class="nav-item"
              ><span class="nav-icon">üè†</span><span class="nav-text"
                >Dashboard</span
              ></a
            >
            <a href="/faturamento" class="nav-item"
              ><span class="nav-icon">üí∞</span><span class="nav-text"
                >Faturamento</span
              ></a
            >
          </nav>
          <nav class="nav-section">
            <div class="nav-title">Gest√£o</div>
            <a href="/ordens" class="nav-item active"
              ><span class="nav-icon">üìã</span><span class="nav-text"
                >Ordens de Servi√ßo</span
              ></a
            >
            <a href="/produtos" class="nav-item"
              ><span class="nav-icon">üì¶</span><span class="nav-text"
                >Produtos</span
              ></a
            >
            <a href="/vendas" class="nav-item"
              ><span class="nav-icon">üõí</span><span class="nav-text"
                >Vendas</span
              ></a
            >
          </nav>
        </aside>

        <main class="main-content">
          <div class="page-header">
            <h1 class="page-title">üìù Nova Ordem de Servi√ßo</h1>
            <p class="page-subtitle">
              Preencha os dados para gerar a ordem de servi√ßo
            </p>
          </div>

          <div class="card">
            <form id="ordemForm" autocomplete="off">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nome do Cliente <span>*</span></label>
                  <input
                    type="text"
                    id="nomeCliente"
                    required
                    placeholder="Ex: Jo√£o da Silva"
                  />
                </div>
                <div class="form-group">
                  <label>Documento (CPF/RG) <span>*</span></label>
                  <input
                    type="text"
                    id="documentoCliente"
                    required
                    placeholder="000.000.000-00"
                  />
                </div>
                <div class="form-group">
                  <label>Telefone <span>*</span></label>
                  <input
                    type="text"
                    id="telefoneCliente"
                    required
                    placeholder="(00) 00000-0000"
                  />
                </div>
                <div class="form-group">
                  <label>Modelo do Aparelho <span>*</span></label>
                  <input
                    type="text"
                    id="modeloAparelho"
                    required
                    placeholder="Ex: iPhone 13 Pro"
                  />
                </div>
                <div class="form-group full">
                  <label>Defeito Apresentado <span>*</span></label>
                  <input
                    type="text"
                    id="defeitoApresentado"
                    required
                    placeholder="Descreva o problema do aparelho"
                  />
                </div>
                <div class="form-group full">
                  <label>Termo de Garantia <span>*</span></label>
                  <textarea id="termoGarantia" required
                    >Garantia de 90 dias para o servi√ßo realizado, conforme
                    legisla√ß√£o vigente. A garantia n√£o cobre danos causados por
                    mau uso, quedas, contato com l√≠quidos ou tentativa de reparo
                    por terceiros.</textarea
                  >
                </div>
                <div class="form-group">
                  <label>Valor do Conserto (R$) <span>*</span></label>
                  <input
                    type="number"
                    id="valorConserto"
                    step="0.01"
                    required
                    placeholder="0.00"
                  />
                </div>
                <div class="form-group">
                  <label>Previs√£o de Entrega</label>
                  <input type="date" id="previsaoEntrega" />
                </div>

                <!-- Upload de Foto do Aparelho -->
                <div class="form-group full">
                  <label>üì∑ Foto do Aparelho</label>
                  <div class="photo-upload-area" id="photoUploadArea">
                    <input type="file" id="fotoAparelho" accept="image/*" />
                    <div id="uploadPlaceholder">
                      <div class="photo-upload-icon">üì∏</div>
                      <p class="photo-upload-text">
                        Clique ou arraste uma foto do aparelho aqui
                      </p>
                    </div>
                    <img
                      id="photoPreview"
                      class="photo-preview"
                      alt="Preview da foto"
                    />
                    <div id="photoActions" class="photo-actions">
                      <button
                        type="button"
                        class="btn btn-small"
                        onclick="window.removerFoto()">üóëÔ∏è Remover</button
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Se√ß√£o de Assinaturas Digitais -->
              <div class="signature-section">
                <h3>‚úçÔ∏è Assinaturas Digitais</h3>
                <div class="signatures-grid">
                  <div class="signature-pad-container">
                    <label>Assinatura do T√©cnico</label>
                    <canvas id="signatureTecnico" class="signature-canvas"
                    ></canvas>
                    <div class="signature-actions">
                      <button
                        type="button"
                        class="btn btn-small"
                        onclick="window.limparAssinatura('Tecnico')"
                        >üóëÔ∏è Limpar</button
                      >
                    </div>
                  </div>
                  <div class="signature-pad-container">
                    <label>Assinatura do Cliente <span>*</span></label>
                    <canvas id="signatureCliente" class="signature-canvas"
                    ></canvas>
                    <div class="signature-actions">
                      <button
                        type="button"
                        class="btn btn-small"
                        onclick="window.limparAssinatura('Cliente')"
                        >üóëÔ∏è Limpar</button
                      >
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <a href="/ordens" class="btn">‚Üê Voltar</a>
                <button type="submit" class="btn btn-primary"
                  >üìÑ Gerar PDF</button
                >
              </div>
            </form>

            <div id="pdfResult"></div>
          </div>
        </main>
      </div>
    </SignedIn>

    <script is:inline>
      // Theme management
      (function() {
        const themeToggle = document.getElementById("themeToggle");
        const themeIcon = themeToggle?.querySelector(".theme-icon");
        
        function initTheme() {
          const savedTheme = localStorage.getItem("scartech_theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = savedTheme || (prefersDark ? "dark" : "light");
          document.documentElement.setAttribute("data-theme", theme);
          updateThemeIcon(theme);
        }
        
        function updateThemeIcon(theme) {
          if (themeIcon) themeIcon.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }
        
        function toggleTheme() {
          const currentTheme = document.documentElement.getAttribute("data-theme");
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          document.documentElement.setAttribute("data-theme", newTheme);
          localStorage.setItem("scartech_theme", newTheme);
          updateThemeIcon(newTheme);
        }
        
        themeToggle?.addEventListener("click", toggleTheme);
        initTheme();
      })();

      // Toggle sidebar
      document.getElementById("toggleBtn")?.addEventListener("click", () => {
        document.getElementById("sidebar")?.classList.toggle("collapsed");
      });

      // ========== UPLOAD DE FOTO ==========
      let fotoDataURL = null;
      const photoUploadArea = document.getElementById("photoUploadArea");
      const fotoInput = document.getElementById("fotoAparelho");
      const photoPreview = document.getElementById("photoPreview");
      const photoActions = document.getElementById("photoActions");
      const uploadPlaceholder = document.getElementById("uploadPlaceholder");

      // Click para selecionar foto
      photoUploadArea?.addEventListener("click", (e) => {
        if (e.target.tagName !== "BUTTON") {
          fotoInput?.click();
        }
      });

      // Drag and drop
      photoUploadArea?.addEventListener("dragover", (e) => {
        e.preventDefault();
        photoUploadArea.style.borderColor = "#00ffff";
        photoUploadArea.style.background = "rgba(0, 255, 255, 0.1)";
      });

      photoUploadArea?.addEventListener("dragleave", () => {
        photoUploadArea.style.borderColor = "rgba(0, 255, 255, 0.3)";
        photoUploadArea.style.background = "rgba(0, 0, 0, 0.2)";
      });

      photoUploadArea?.addEventListener("drop", (e) => {
        e.preventDefault();
        photoUploadArea.style.borderColor = "rgba(0, 255, 255, 0.3)";
        photoUploadArea.style.background = "rgba(0, 0, 0, 0.2)";
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          processarFoto(file);
        }
      });

      fotoInput?.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) processarFoto(file);
      });

      function processarFoto(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          fotoDataURL = e.target.result;
          photoPreview.src = fotoDataURL;
          photoPreview.classList.add("visible");
          photoActions.classList.add("visible");
          uploadPlaceholder.style.display = "none";
          photoUploadArea.classList.add("has-image");
        };
        reader.readAsDataURL(file);
      }

      window.removerFoto = function () {
        fotoDataURL = null;
        photoPreview.src = "";
        photoPreview.classList.remove("visible");
        photoActions.classList.remove("visible");
        uploadPlaceholder.style.display = "block";
        photoUploadArea.classList.remove("has-image");
        fotoInput.value = "";
      };

      // ========== ASSINATURA DIGITAL ==========
      const signaturePads = {};

      function initSignaturePad(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
          console.error("Canvas n√£o encontrado:", canvasId);
          return;
        }

        const ctx = canvas.getContext("2d");
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Ajustar tamanho do canvas
        function resizeCanvas() {
          const rect = canvas.getBoundingClientRect();
          // Garantir dimens√µes m√≠nimas
          const width = rect.width > 0 ? rect.width : 300;
          const height = rect.height > 0 ? rect.height : 150;

          // Salvar o conte√∫do atual antes de redimensionar
          const imageData =
            canvas.width > 0 && canvas.height > 0
              ? ctx.getImageData(0, 0, canvas.width, canvas.height)
              : null;

          canvas.width = width;
          canvas.height = height;

          // Preencher com branco
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Restaurar conte√∫do se existia
          if (imageData) {
            ctx.putImageData(imageData, 0, 0);
          }

          // Configurar estilo de desenho
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
        }

        // Inicializar ap√≥s o DOM estar pronto
        setTimeout(resizeCanvas, 100);
        window.addEventListener("resize", resizeCanvas);

        function getPos(e) {
          const rect = canvas.getBoundingClientRect();
          if (e.touches && e.touches.length > 0) {
            return {
              x: e.touches[0].clientX - rect.left,
              y: e.touches[0].clientY - rect.top,
            };
          }
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
          };
        }

        function startDrawing(e) {
          e.preventDefault();
          isDrawing = true;
          const pos = getPos(e);
          lastX = pos.x;
          lastY = pos.y;
          // Desenhar um ponto inicial
          ctx.beginPath();
          ctx.arc(lastX, lastY, 1, 0, Math.PI * 2);
          ctx.fill();
        }

        function draw(e) {
          if (!isDrawing) return;
          e.preventDefault();

          const pos = getPos(e);

          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(pos.x, pos.y);
          ctx.stroke();

          lastX = pos.x;
          lastY = pos.y;
        }

        function stopDrawing(e) {
          if (e) e.preventDefault();
          isDrawing = false;
        }

        // Mouse events
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);

        // Touch events - passive: false para permitir preventDefault
        canvas.addEventListener("touchstart", startDrawing, { passive: false });
        canvas.addEventListener("touchmove", draw, { passive: false });
        canvas.addEventListener("touchend", stopDrawing, { passive: false });

        signaturePads[canvasId] = {
          canvas,
          ctx,
          clear: () => {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          },
          isEmpty: () => {
            // Verificar se o canvas tem dimens√µes v√°lidas
            if (canvas.width === 0 || canvas.height === 0) {
              return true; // Canvas n√£o inicializado = vazio
            }
            try {
              const pixelData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height,
              ).data;
              for (let i = 0; i < pixelData.length; i += 4) {
                if (
                  pixelData[i] !== 255 ||
                  pixelData[i + 1] !== 255 ||
                  pixelData[i + 2] !== 255
                ) {
                  return false;
                }
              }
              return true;
            } catch (e) {
              return true; // Em caso de erro, considerar vazio
            }
          },
          toDataURL: () => canvas.toDataURL("image/png"),
        };
      }

      // Inicializar as assinaturas
      initSignaturePad("signatureTecnico");
      initSignaturePad("signatureCliente");

      window.limparAssinatura = function (tipo) {
        const pad = signaturePads["signature" + tipo];
        if (pad) pad.clear();
      };

      document
        .getElementById("ordemForm")
        ?.addEventListener("submit", async function (e) {
          e.preventDefault();

          const resultDiv = document.getElementById("pdfResult");

          // Verificar assinatura do cliente (opcional agora para teste)
          const signatureCliente = signaturePads["signatureCliente"];
          if (signatureCliente && signatureCliente.isEmpty()) {
            const confirmar = confirm(
              "A assinatura do cliente est√° vazia. Deseja continuar mesmo assim?",
            );
            if (!confirmar) return;
          }

          resultDiv.className = "loading";
          resultDiv.textContent = "‚è≥ Gerando PDF...";

          const dados = {
            nomeCliente: document.getElementById("nomeCliente").value,
            documentoCliente: document.getElementById("documentoCliente").value,
            telefoneCliente: document.getElementById("telefoneCliente").value,
            modeloAparelho: document.getElementById("modeloAparelho").value,
            defeitoApresentado:
              document.getElementById("defeitoApresentado").value,
            termoGarantia: document.getElementById("termoGarantia").value,
            valorConserto: document.getElementById("valorConserto").value,
            previsaoEntrega: document.getElementById("previsaoEntrega").value,
          };

          try {
            // Verificar se jsPDF est√° carregado
            if (!window.jspdf) {
              throw new Error(
                "Biblioteca jsPDF n√£o carregou. Recarregue a p√°gina.",
              );
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const dataAtual = new Date().toLocaleString("pt-BR");
            const numOS = Date.now().toString().slice(-8);

            // Cabe√ßalho
            doc.setFontSize(22);
            doc.setTextColor(0, 200, 200);
            doc.text("ORDEM DE SERVI√áO", 105, 20, { align: "center" });

            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text("ScarTech Solutions - Assist√™ncia T√©cnica", 105, 28, {
              align: "center",
            });

            // Linha separadora
            doc.setDrawColor(0, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(15, 35, 195, 35);

            // Data e n√∫mero da OS
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Data: ${dataAtual}`, 15, 45);
            doc.text(`OS N¬∫: ${numOS}`, 195, 45, { align: "right" });

            // Se√ß√£o: Dados do Cliente
            doc.setFillColor(240, 250, 255);
            doc.rect(15, 52, 180, 10, "F");
            doc.setFontSize(12);
            doc.setTextColor(0, 150, 150);
            doc.text("DADOS DO CLIENTE", 20, 59);

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            let y = 70;

            doc.setFont(undefined, "bold");
            doc.text("Nome:", 20, y);
            doc.setFont(undefined, "normal");
            doc.text(dados.nomeCliente, 55, y);
            y += 8;

            doc.setFont(undefined, "bold");
            doc.text("Documento:", 20, y);
            doc.setFont(undefined, "normal");
            doc.text(dados.documentoCliente, 55, y);
            y += 8;

            doc.setFont(undefined, "bold");
            doc.text("Telefone:", 20, y);
            doc.setFont(undefined, "normal");
            doc.text(dados.telefoneCliente, 55, y);
            y += 15;

            // Se√ß√£o: Dados do Aparelho
            doc.setFillColor(240, 250, 255);
            doc.rect(15, y, 180, 10, "F");
            doc.setFontSize(12);
            doc.setTextColor(0, 150, 150);
            doc.text("DADOS DO APARELHO", 20, y + 7);
            y += 17;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, "bold");
            doc.text("Modelo:", 20, y);
            doc.setFont(undefined, "normal");
            doc.text(dados.modeloAparelho, 55, y);
            y += 8;

            doc.setFont(undefined, "bold");
            doc.text("Defeito:", 20, y);
            doc.setFont(undefined, "normal");
            const defeitoLinhas = doc.splitTextToSize(
              dados.defeitoApresentado,
              135,
            );
            doc.text(defeitoLinhas, 55, y);
            y += defeitoLinhas.length * 6 + 10;

            // Foto do aparelho (se anexada)
            if (fotoDataURL) {
              doc.setFillColor(240, 250, 255);
              doc.rect(15, y, 180, 10, "F");
              doc.setFontSize(12);
              doc.setTextColor(0, 150, 150);
              doc.text("FOTO DO APARELHO", 20, y + 7);
              y += 15;

              try {
                doc.addImage(fotoDataURL, "JPEG", 55, y, 100, 60);
                y += 68;
              } catch (imgError) {
                doc.setFontSize(9);
                doc.setTextColor(150, 150, 150);
                doc.text("[Foto anexada - erro ao carregar]", 105, y + 30, {
                  align: "center",
                });
                y += 40;
              }
            }

            // Valor do conserto
            doc.setFillColor(220, 255, 240);
            doc.rect(15, y, 180, 14, "F");
            doc.setFontSize(14);
            doc.setTextColor(0, 150, 100);
            doc.text(
              `VALOR DO CONSERTO: R$ ${parseFloat(dados.valorConserto).toFixed(2)}`,
              105,
              y + 10,
              { align: "center" },
            );
            y += 22;

            // Previs√£o de entrega (se preenchida)
            if (dados.previsaoEntrega) {
              const dataEntrega = new Date(
                dados.previsaoEntrega + "T00:00:00",
              ).toLocaleDateString("pt-BR");
              doc.setFontSize(11);
              doc.setTextColor(100, 100, 100);
              doc.text(`Previs√£o de Entrega: ${dataEntrega}`, 105, y, {
                align: "center",
              });
              y += 12;
            }

            // Verificar se precisa nova p√°gina
            if (y > 200) {
              doc.addPage();
              y = 20;
            }

            // Termo de garantia
            doc.setFillColor(240, 250, 255);
            doc.rect(15, y, 180, 10, "F");
            doc.setFontSize(12);
            doc.setTextColor(0, 150, 150);
            doc.text("TERMO DE GARANTIA", 20, y + 7);
            y += 17;

            doc.setFontSize(9);
            doc.setTextColor(60, 60, 60);
            const garantiaLinhas = doc.splitTextToSize(
              dados.termoGarantia,
              170,
            );
            doc.text(garantiaLinhas, 20, y);
            y += garantiaLinhas.length * 5 + 15;

            // Verificar se precisa nova p√°gina para assinaturas
            if (y > 220) {
              doc.addPage();
              y = 20;
            }

            // Assinaturas Digitais
            doc.setFillColor(240, 250, 255);
            doc.rect(15, y, 180, 10, "F");
            doc.setFontSize(12);
            doc.setTextColor(0, 150, 150);
            doc.text("ASSINATURAS", 20, y + 7);
            y += 17;

            // Assinatura do T√©cnico
            const signatureTecnico = signaturePads["signatureTecnico"];
            if (signatureTecnico && !signatureTecnico.isEmpty()) {
              try {
                doc.addImage(
                  signatureTecnico.toDataURL(),
                  "PNG",
                  20,
                  y,
                  70,
                  35,
                );
              } catch (e) {}
            }

            // Assinatura do Cliente
            if (signatureCliente && !signatureCliente.isEmpty()) {
              try {
                doc.addImage(
                  signatureCliente.toDataURL(),
                  "PNG",
                  120,
                  y,
                  70,
                  35,
                );
              } catch (e) {}
            }

            y += 38;

            // Labels das assinaturas
            doc.setDrawColor(100, 100, 100);
            doc.line(20, y, 90, y);
            doc.line(120, y, 190, y);
            y += 5;

            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text("Assinatura do T√©cnico", 55, y, { align: "center" });
            doc.text("Assinatura do Cliente", 155, y, { align: "center" });

            // Rodap√©
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(
              "ScarTech Solutions - Assist√™ncia T√©cnica Especializada",
              105,
              285,
              { align: "center" },
            );

            // Salva o PDF
            doc.save(`OS_${numOS}.pdf`);

            // Salvar usando API da nuvem
            const novaOrdem = {
              cliente: dados.nomeCliente,
              equipamento: dados.modeloAparelho,
              descricao: dados.defeitoApresentado,
              valorConserto: parseFloat(dados.valorConserto),
              status: "aberta",
              data: new Date().toLocaleDateString("pt-BR"),
              numOS: numOS,
            };

            // Salvar no localStorage primeiro
            let ordens = JSON.parse(
              localStorage.getItem("scartech_ordens") || "[]",
            );
            ordens.push(novaOrdem);
            localStorage.setItem("scartech_ordens", JSON.stringify(ordens));

            // Tentar salvar na nuvem se o Clerk estiver dispon√≠vel
            if (
              typeof window.Clerk !== "undefined" &&
              window.Clerk.user &&
              window.ScartechCloud
            ) {
              try {
                const clerkEmail = window.Clerk.user.primaryEmailAddress?.emailAddress;
                if (clerkEmail) {
                  window.ScartechCloud.init(clerkEmail);
                  await window.ScartechCloud.saveOrdens(ordens);
                  console.log("Ordem salva na nuvem com sucesso!");
                }
              } catch (cloudError) {
                console.warn("Erro ao salvar na nuvem:", cloudError);
              }
            }

            // Enviar para o backend para persist√™ncia e contabilidade
            try {
              const response = await fetch("/api/orders/registrar", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(novaOrdem),
              });
              if (!response.ok) {
                throw new Error("Erro ao registrar ordem no backend");
              }
              console.log("Ordem registrada no backend com sucesso!");
            } catch (backendError) {
              console.warn("Erro ao registrar ordem no backend:", backendError);
            }

            resultDiv.className = "success";
            resultDiv.textContent =
              "‚úÖ PDF gerado com sucesso! O download iniciou automaticamente.";

            // Limpar formul√°rio ap√≥s 2 segundos
            setTimeout(() => {
              document.getElementById("ordemForm").reset();
              document.getElementById("termoGarantia").value =
                "Garantia de 90 dias para o servi√ßo realizado, conforme legisla√ß√£o vigente. A garantia n√£o cobre danos causados por mau uso, quedas, contato com l√≠quidos ou tentativa de reparo por terceiros.";
              // Limpar foto
              window.removerFoto();
              // Limpar assinaturas
              window.limparAssinatura("Tecnico");
              window.limparAssinatura("Cliente");
            }, 2000);
          } catch (error) {
            resultDiv.className = "error";
            resultDiv.textContent = "‚ùå Erro ao gerar PDF: " + error.message;
            console.error("Erro PDF:", error);
          }
        });

      // Mobile Menu Toggle
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const sidebar = document.getElementById("sidebar");

      function toggleMobileMenu() {
        mobileMenuBtn?.classList.toggle("active");
        sidebar?.classList.toggle("open");
        sidebarOverlay?.classList.toggle("visible");
      }

      mobileMenuBtn?.addEventListener("click", toggleMobileMenu);
      sidebarOverlay?.addEventListener("click", toggleMobileMenu);
    </script>
  </body>
</html>
