---
import { SignedIn, SignedOut } from '@clerk/astro/components';
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0a0a0f" />
    <title>Vendas e Relat√≥rios - ScarTech Solutions</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; }
      .layout { display: flex; min-height: 100vh; }
      .sidebar { width: 260px; background: linear-gradient(180deg, #0d0d12 0%, #12121a 100%); border-right: 1px solid rgba(0, 255, 255, 0.1); padding: 20px 0; display: flex; flex-direction: column; transition: width 0.3s ease; position: relative; }
      .sidebar.collapsed { width: 70px; }
      .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); display: flex; align-items: center; gap: 12px; }
      .sidebar.collapsed .sidebar-header { justify-content: center; padding: 0 10px 20px; }
      .logo-img { width: 40px; height: 40px; border-radius: 8px; }
      .logo-text { font-size: 1.2rem; font-weight: 700; color: #00ffff; white-space: nowrap; }
      .sidebar.collapsed .logo-text { display: none; }
      .toggle-btn { position: absolute; top: 20px; right: -15px; width: 30px; height: 30px; background: #1a1a2e; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #00ffff; transition: all 0.3s ease; z-index: 10; }
      .toggle-btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
      .hamburger { display: flex; flex-direction: column; gap: 3px; }
      .hamburger span { display: block; width: 14px; height: 2px; background: #00ffff; }
      .nav-section { padding: 20px 0; }
      .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #666; padding: 0 20px; margin-bottom: 10px; letter-spacing: 1px; }
      .sidebar.collapsed .nav-title { display: none; }
      .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #a0a0a0; text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; }
      .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 10px; }
      .nav-item:hover { background: rgba(0, 255, 255, 0.05); color: #00ffff; border-left-color: #00ffff; box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1); }
      .nav-item.active { background: rgba(0, 255, 255, 0.1); color: #00ffff; border-left-color: #00ffff; }
      .nav-icon { font-size: 1.2rem; width: 24px; text-align: center; }
      .nav-text { white-space: nowrap; }
      .sidebar.collapsed .nav-text { display: none; }
      .main-content { flex: 1; padding: 30px; overflow-y: auto; }
      .page-header { margin-bottom: 30px; }
      .page-title { font-size: 1.8rem; color: #fff; margin-bottom: 5px; }
      .page-subtitle { color: #666; }

      /* Tabs de navega√ß√£o */
      .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); padding-bottom: 15px; }
      .tab { padding: 10px 20px; background: transparent; border: 1px solid rgba(0, 255, 255, 0.2); color: #a0a0a0; border-radius: 8px 8px 0 0; cursor: pointer; transition: all 0.3s ease; font-size: 0.95rem; }
      .tab:hover { background: rgba(0, 255, 255, 0.05); color: #00ffff; }
      .tab.active { background: rgba(0, 255, 255, 0.1); color: #00ffff; border-color: #00ffff; border-bottom-color: transparent; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* Cards de estat√≠sticas */
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
      .stat-card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 18px; }
      .stat-card.green { border-color: rgba(0, 255, 136, 0.3); }
      .stat-card.blue { border-color: rgba(0, 136, 255, 0.3); }
      .stat-card.purple { border-color: rgba(136, 0, 255, 0.3); }
      .stat-card.orange { border-color: rgba(255, 136, 0, 0.3); }
      .stat-icon { font-size: 1.8rem; margin-bottom: 8px; }
      .stat-value { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 3px; }
      .stat-label { font-size: 0.8rem; color: #666; }
      .stat-card.green .stat-value { color: #00ff88; }
      .stat-card.blue .stat-value { color: #00d4ff; }
      .stat-card.purple .stat-value { color: #aa88ff; }
      .stat-card.orange .stat-value { color: #ffaa00; }

      /* Cards gerais */
      .card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
      .card-title { font-size: 1.2rem; color: #00ffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

      /* Gr√°ficos */
      .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px; }
      .chart-card { background: linear-gradient(145deg, #12121a 0%, #1a1a2e 100%); border: 1px solid rgba(0, 255, 255, 0.1); border-radius: 12px; padding: 20px; }
      .chart-title { font-size: 1rem; color: #00ffff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
      .chart-container { position: relative; height: 250px; }

      /* Tabela */
      table { width: 100%; border-collapse: collapse; margin-top: 15px; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(0, 255, 255, 0.1); }
      th { color: #00ffff; font-weight: 600; font-size: 0.9rem; }
      tr:hover { background: rgba(0, 255, 255, 0.05); }
      .valor { color: #00ff88; font-weight: 600; }
      .trend-up { color: #00ff88; }
      .trend-down { color: #ff6b6b; }

      /* Bot√µes */
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(0, 255, 255, 0.05) 100%); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; font-size: 0.95rem; }
      .btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); transform: translateY(-2px); }
      .btn-primary { background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; border: none; font-weight: 600; }
      .btn-primary:hover { box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); }
      .btn-delete { padding: 6px 10px; font-size: 0.8rem; background: rgba(255,100,100,0.2); border-color: rgba(255,100,100,0.3); color: #ff6b6b; }
      .btn-edit { padding: 6px 10px; font-size: 0.8rem; background: rgba(255,200,0,0.2); border-color: rgba(255,200,0,0.3); color: #ffcc00; margin-right: 5px; }

      /* Modal */
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
      .modal.active { display: flex; }
      .modal-content { background: #12121a; border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 30px; width: 100%; max-width: 450px; }
      .modal-content h3 { color: #00ffff; margin-bottom: 20px; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; color: #a0a0a0; margin-bottom: 5px; font-size: 0.9rem; }
      .form-group input, .form-group select { width: 100%; padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 6px; color: #fff; font-size: 1rem; }
      .form-group input:focus, .form-group select:focus { outline: none; border-color: #00ffff; }
      .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

      .empty-message { color: #666; text-align: center; padding: 20px; }
      .not-signed-in { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 20px; }
      .login-btn { padding: 12px 30px; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; }
      .actions-cell { white-space: nowrap; }

      @media (max-width: 768px) {
        .sidebar { display: none; }
        .main-content { padding: 15px; }
        .charts-grid { grid-template-columns: 1fr; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        .tabs { flex-wrap: wrap; }
        .tab { flex: 1; min-width: 100px; text-align: center; font-size: 0.85rem; padding: 8px 12px; }
        table { font-size: 0.85rem; display: block; overflow-x: auto; }
      }

      @media (max-width: 480px) {
        .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { padding: 12px; }
        .stat-value { font-size: 1.2rem; }
        .chart-container { height: 200px; }
        .charts-grid { gap: 15px; }
      }
    </style>
  </head>
  <body>
    <SignedOut>
      <div class="not-signed-in">
        <h2>Acesso Restrito</h2>
        <a href="/" class="login-btn">Fazer Login</a>
      </div>
    </SignedOut>

    <SignedIn>
      <div class="layout">
        <aside class="sidebar" id="sidebar">
          <button class="toggle-btn" id="toggleBtn">
            <div class="hamburger"><span></span><span></span><span></span></div>
          </button>
          <div class="sidebar-header">
            <img src="/logo.png" alt="ScarTech" class="logo-img" />
            <span class="logo-text">ScarTech</span>
          </div>
          <nav class="nav-section">
            <div class="nav-title">Principal</div>
            <a href="/dashboard" class="nav-item"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a>
            <a href="/faturamento" class="nav-item"><span class="nav-icon">üí∞</span><span class="nav-text">Faturamento</span></a>
          </nav>
          <nav class="nav-section">
            <div class="nav-title">Gest√£o</div>
            <a href="/ordens" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Ordens de Servi√ßo</span></a>
            <a href="/produtos" class="nav-item"><span class="nav-icon">üì¶</span><span class="nav-text">Produtos</span></a>
            <a href="/vendas" class="nav-item active"><span class="nav-icon">üõí</span><span class="nav-text">Vendas & Relat√≥rios</span></a>
          </nav>
        </aside>

        <main class="main-content">
          <div class="page-header">
            <h1 class="page-title">üõí Vendas e Relat√≥rios</h1>
            <p class="page-subtitle">Gerencie vendas e visualize o desempenho do neg√≥cio</p>
          </div>

          <!-- Tabs -->
          <div class="tabs">
            <button class="tab active" onclick="window.mostrarTab('vendas')">üõí Vendas</button>
            <button class="tab" onclick="window.mostrarTab('relatorios')">üìä Relat√≥rios</button>
            <button class="tab" onclick="window.mostrarTab('topServicos')">üèÜ Top Servi√ßos</button>
          </div>

          <!-- Tab Vendas -->
          <div class="tab-content active" id="tabVendas">
            <!-- Estat√≠sticas r√°pidas -->
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalVendasValor">R$ 0,00</div>
                <div class="stat-label">Total em Vendas</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-icon">üõí</div>
                <div class="stat-value" id="qtdVendas">0</div>
                <div class="stat-label">Vendas Realizadas</div>
              </div>
              <div class="stat-card purple">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="ticketMedioVendas">R$ 0,00</div>
                <div class="stat-label">Ticket M√©dio</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="vendasHoje">0</div>
                <div class="stat-label">Vendas Hoje</div>
              </div>
            </div>

            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 class="card-title" style="margin-bottom: 0;">üìã Lista de Vendas</h2>
                <button class="btn btn-primary" onclick="window.abrirModalVenda()">+ Nova Venda</button>
              </div>
              
              <table>
                <thead>
                  <tr>
                    <th>N¬∫</th>
                    <th>Cliente</th>
                    <th>Produto</th>
                    <th>Qtd</th>
                    <th>Valor</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="vendasBody">
                  <tr><td colspan="7" class="empty-message">Nenhuma venda registrada</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab Relat√≥rios -->
          <div class="tab-content" id="tabRelatorios">
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalFaturamento">R$ 0,00</div>
                <div class="stat-label">Faturamento Total</div>
              </div>
              <div class="stat-card blue">
                <div class="stat-icon">üìã</div>
                <div class="stat-value" id="totalOrdens">0</div>
                <div class="stat-label">Ordens de Servi√ßo</div>
              </div>
              <div class="stat-card purple">
                <div class="stat-icon">üõí</div>
                <div class="stat-value" id="totalVendasRelat">0</div>
                <div class="stat-label">Vendas Realizadas</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="ticketMedio">R$ 0,00</div>
                <div class="stat-label">Ticket M√©dio</div>
              </div>
            </div>

            <div class="charts-grid">
              <div class="chart-card">
                <h3 class="chart-title">üìà Faturamento Mensal</h3>
                <div class="chart-container">
                  <canvas id="chartFaturamento"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <h3 class="chart-title">ü•ß Distribui√ß√£o por Categoria</h3>
                <div class="chart-container">
                  <canvas id="chartCategoria"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <h3 class="chart-title">üìä Ordens por Status</h3>
                <div class="chart-container">
                  <canvas id="chartStatus"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <h3 class="chart-title">üìÖ Vendas por Dia da Semana</h3>
                <div class="chart-container">
                  <canvas id="chartDiaSemana"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Top Servi√ßos -->
          <div class="tab-content" id="tabTopServicos">
            <div class="card">
              <h3 class="card-title">üèÜ Top Servi√ßos Mais Realizados</h3>
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Tipo de Servi√ßo</th>
                    <th>Quantidade</th>
                    <th>Receita Total</th>
                    <th>Tend√™ncia</th>
                  </tr>
                </thead>
                <tbody id="topServicosBody">
                </tbody>
              </table>
            </div>

            <div class="card">
              <h3 class="card-title">üõçÔ∏è Produtos Mais Vendidos</h3>
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Receita Total</th>
                  </tr>
                </thead>
                <tbody id="topProdutosBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Modal Nova Venda -->
          <div class="modal" id="modalVenda">
            <div class="modal-content">
              <h3>üõí Nova Venda</h3>
              <form id="formVenda">
                <div class="form-group">
                  <label>Cliente</label>
                  <input type="text" id="clienteVenda" required placeholder="Nome do cliente" />
                </div>
                <div class="form-group">
                  <label>Produto</label>
                  <input type="text" id="produtoVenda" required placeholder="Nome do produto" />
                </div>
                <div class="form-group">
                  <label>Quantidade</label>
                  <input type="number" id="quantidadeVenda" min="1" value="1" required />
                </div>
                <div class="form-group">
                  <label>Valor Unit√°rio (R$)</label>
                  <input type="number" id="valorVenda" step="0.01" min="0" required placeholder="0.00" />
                </div>
                <div class="form-group">
                  <label>Total: <span id="totalVendaCalc" style="color: #00ff88; font-weight: bold;">R$ 0,00</span></label>
                </div>
                <div class="modal-actions">
                  <button type="button" class="btn" onclick="window.fecharModalVenda()">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Modal Editar Venda -->
          <div class="modal" id="modalEditarVenda">
            <div class="modal-content">
              <h3>‚úèÔ∏è Editar Venda</h3>
              <form id="formEditarVenda">
                <input type="hidden" id="editarVendaIndex" />
                <div class="form-group">
                  <label>Cliente</label>
                  <input type="text" id="editarClienteVenda" required />
                </div>
                <div class="form-group">
                  <label>Produto</label>
                  <input type="text" id="editarProdutoVenda" required />
                </div>
                <div class="form-group">
                  <label>Quantidade</label>
                  <input type="number" id="editarQuantidadeVenda" min="1" required />
                </div>
                <div class="form-group">
                  <label>Valor Unit√°rio (R$)</label>
                  <input type="number" id="editarValorVenda" step="0.01" min="0" required />
                </div>
                <div class="modal-actions">
                  <button type="button" class="btn" onclick="window.fecharEditarVenda()">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
              </form>
            </div>
          </div>

          <a href="/dashboard" class="btn" style="margin-top: 20px;">‚Üê Voltar ao Dashboard</a>
        </main>
      </div>
    </SignedIn>

    <script is:inline>
      // Toggle sidebar
      document.getElementById('toggleBtn')?.addEventListener('click', () => {
        document.getElementById('sidebar')?.classList.toggle('collapsed');
      });

      // Gerenciamento de Tabs
      window.mostrarTab = function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        
        if (tab === 'relatorios') {
          setTimeout(() => atualizarGraficos(), 100);
        }
      };

      // Dados
      let vendas = JSON.parse(localStorage.getItem('scartech_vendas') || '[]');
      let ordens = JSON.parse(localStorage.getItem('scartech_ordens') || '[]');

      // Calcular total em tempo real no modal
      document.getElementById('quantidadeVenda')?.addEventListener('input', calcularTotal);
      document.getElementById('valorVenda')?.addEventListener('input', calcularTotal);

      function calcularTotal() {
        const qtd = parseFloat(document.getElementById('quantidadeVenda').value) || 0;
        const valor = parseFloat(document.getElementById('valorVenda').value) || 0;
        document.getElementById('totalVendaCalc').textContent = `R$ ${(qtd * valor).toFixed(2)}`;
      }

      // Renderizar vendas
      function renderVendas() {
        const tbody = document.getElementById('vendasBody');
        if (vendas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-message">Nenhuma venda registrada</td></tr>';
        } else {
          tbody.innerHTML = vendas.map((v, i) => `
            <tr>
              <td>#V${String(i + 1).padStart(3, '0')}</td>
              <td>${v.cliente || '-'}</td>
              <td>${v.produto || '-'}</td>
              <td>${v.quantidade || 1}</td>
              <td class="valor">R$ ${(v.total || v.valor || 0).toFixed(2)}</td>
              <td>${v.data || '-'}</td>
              <td class="actions-cell">
                <button class="btn btn-edit" onclick="window.editarVenda(${i})" title="Editar">‚úèÔ∏è</button>
                <button class="btn btn-delete" onclick="window.excluirVenda(${i})" title="Excluir">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('');
        }
        atualizarEstatisticasVendas();
      }

      // Estat√≠sticas de vendas
      function atualizarEstatisticasVendas() {
        const total = vendas.reduce((sum, v) => sum + (v.total || v.valor || 0), 0);
        const qtd = vendas.length;
        const ticket = qtd > 0 ? total / qtd : 0;
        
        const hoje = new Date().toLocaleDateString('pt-BR');
        const vendasHoje = vendas.filter(v => v.data === hoje).length;

        document.getElementById('totalVendasValor').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('qtdVendas').textContent = qtd;
        document.getElementById('ticketMedioVendas').textContent = `R$ ${ticket.toFixed(2)}`;
        document.getElementById('vendasHoje').textContent = vendasHoje;
      }

      // Modal Venda
      window.abrirModalVenda = function() {
        document.getElementById('modalVenda').classList.add('active');
        document.getElementById('totalVendaCalc').textContent = 'R$ 0,00';
      };

      window.fecharModalVenda = function() {
        document.getElementById('modalVenda').classList.remove('active');
        document.getElementById('formVenda').reset();
      };

      window.editarVenda = function(index) {
        const v = vendas[index];
        document.getElementById('editarVendaIndex').value = index;
        document.getElementById('editarClienteVenda').value = v.cliente || '';
        document.getElementById('editarProdutoVenda').value = v.produto || '';
        document.getElementById('editarQuantidadeVenda').value = v.quantidade || 1;
        document.getElementById('editarValorVenda').value = v.valor || v.total || 0;
        document.getElementById('modalEditarVenda').classList.add('active');
      };

      window.fecharEditarVenda = function() {
        document.getElementById('modalEditarVenda').classList.remove('active');
        document.getElementById('formEditarVenda').reset();
      };

      window.excluirVenda = function(index) {
        if (confirm('Tem certeza que deseja excluir esta venda?')) {
          vendas.splice(index, 1);
          localStorage.setItem('scartech_vendas', JSON.stringify(vendas));
          renderVendas();
          alert('üóëÔ∏è Venda exclu√≠da!');
        }
      };

      document.getElementById('formVenda')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const qtd = parseFloat(document.getElementById('quantidadeVenda').value) || 1;
        const valorUnit = parseFloat(document.getElementById('valorVenda').value) || 0;
        const venda = {
          cliente: document.getElementById('clienteVenda').value,
          produto: document.getElementById('produtoVenda').value,
          quantidade: qtd,
          valor: valorUnit,
          total: qtd * valorUnit,
          data: new Date().toLocaleDateString('pt-BR')
        };
        vendas.push(venda);
        localStorage.setItem('scartech_vendas', JSON.stringify(vendas));
        window.fecharModalVenda();
        renderVendas();
        alert('‚úÖ Venda registrada com sucesso!');
      });

      document.getElementById('formEditarVenda')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const index = parseInt(document.getElementById('editarVendaIndex').value);
        const qtd = parseFloat(document.getElementById('editarQuantidadeVenda').value) || 1;
        const valorUnit = parseFloat(document.getElementById('editarValorVenda').value) || 0;
        vendas[index].cliente = document.getElementById('editarClienteVenda').value;
        vendas[index].produto = document.getElementById('editarProdutoVenda').value;
        vendas[index].quantidade = qtd;
        vendas[index].valor = valorUnit;
        vendas[index].total = qtd * valorUnit;
        localStorage.setItem('scartech_vendas', JSON.stringify(vendas));
        window.fecharEditarVenda();
        renderVendas();
        alert('‚úÖ Venda atualizada!');
      });

      // Fechar modais ao clicar fora
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.remove('active');
        });
      });

      // ========== GR√ÅFICOS ==========
      const cores = {
        cyan: '#00ffff',
        cyanTransp: 'rgba(0, 255, 255, 0.2)',
        green: '#00ff88',
        greenTransp: 'rgba(0, 255, 136, 0.2)',
        purple: '#aa88ff',
        purpleTransp: 'rgba(170, 136, 255, 0.2)',
        orange: '#ffaa00',
        orangeTransp: 'rgba(255, 170, 0, 0.2)',
        red: '#ff6b6b',
        blue: '#00d4ff',
        blueTransp: 'rgba(0, 212, 255, 0.2)'
      };

      Chart.defaults.color = '#a0a0a0';
      Chart.defaults.borderColor = 'rgba(0, 255, 255, 0.1)';

      let chartFaturamento, chartCategoria, chartStatus, chartDiaSemana;

      function atualizarGraficos() {
        const faturamentoOrdens = ordens.reduce((sum, o) => sum + (parseFloat(o.valor) || 0), 0);
        const faturamentoVendas = vendas.reduce((sum, v) => sum + (v.total || v.valor || 0), 0);
        const totalFaturamento = faturamentoOrdens + faturamentoVendas;
        const totalTransacoes = ordens.length + vendas.length;
        const ticketMedio = totalTransacoes > 0 ? totalFaturamento / totalTransacoes : 0;

        document.getElementById('totalFaturamento').textContent = `R$ ${totalFaturamento.toFixed(2)}`;
        document.getElementById('totalOrdens').textContent = ordens.length;
        document.getElementById('totalVendasRelat').textContent = vendas.length;
        document.getElementById('ticketMedio').textContent = `R$ ${ticketMedio.toFixed(2)}`;

        // Gr√°fico Faturamento
        const ctx1 = document.getElementById('chartFaturamento')?.getContext('2d');
        if (ctx1) {
          if (chartFaturamento) chartFaturamento.destroy();
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          const mesAtual = new Date().getMonth();
          const dadosMensais = meses.map((_, i) => {
            if (i === mesAtual) return totalFaturamento;
            if (i === mesAtual - 1) return totalFaturamento * 0.85;
            return Math.random() * totalFaturamento * 0.5;
          });
          chartFaturamento = new Chart(ctx1, {
            type: 'line',
            data: {
              labels: meses,
              datasets: [{
                label: 'Faturamento (R$)',
                data: dadosMensais,
                borderColor: cores.cyan,
                backgroundColor: cores.cyanTransp,
                fill: true,
                tension: 0.4
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
          });
        }

        // Gr√°fico Categoria
        const ctx2 = document.getElementById('chartCategoria')?.getContext('2d');
        if (ctx2) {
          if (chartCategoria) chartCategoria.destroy();
          chartCategoria = new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['Servi√ßos (OS)', 'Vendas'],
              datasets: [{
                data: [faturamentoOrdens || 1, faturamentoVendas || 1],
                backgroundColor: [cores.cyan, cores.green],
                borderColor: '#0a0a0f',
                borderWidth: 3
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
          });
        }

        // Gr√°fico Status
        const ctx3 = document.getElementById('chartStatus')?.getContext('2d');
        if (ctx3) {
          if (chartStatus) chartStatus.destroy();
          const abertas = ordens.filter(o => o.status === 'aberta').length;
          const concluidas = ordens.filter(o => o.status === 'concluida').length;
          chartStatus = new Chart(ctx3, {
            type: 'bar',
            data: {
              labels: ['Abertas', 'Conclu√≠das'],
              datasets: [{
                data: [abertas, concluidas],
                backgroundColor: [cores.orangeTransp, cores.greenTransp],
                borderColor: [cores.orange, cores.green],
                borderWidth: 2,
                borderRadius: 8
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
          });
        }

        // Gr√°fico Dia Semana
        const ctx4 = document.getElementById('chartDiaSemana')?.getContext('2d');
        if (ctx4) {
          if (chartDiaSemana) chartDiaSemana.destroy();
          chartDiaSemana = new Chart(ctx4, {
            type: 'bar',
            data: {
              labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'],
              datasets: [{
                label: 'Vendas',
                data: [1, 5, 8, 6, 9, 7, 3],
                backgroundColor: cores.purpleTransp,
                borderColor: cores.purple,
                borderWidth: 2,
                borderRadius: 8
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
          });
        }
      }

      // Top Servi√ßos
      function renderTopServicos() {
        const servicos = {};
        ordens.forEach(o => {
          const tipo = o.equipamento || 'Servi√ßo Geral';
          if (!servicos[tipo]) servicos[tipo] = { qtd: 0, receita: 0 };
          servicos[tipo].qtd++;
          servicos[tipo].receita += parseFloat(o.valor) || 0;
        });

        const sorted = Object.entries(servicos).sort((a, b) => b[1].qtd - a[1].qtd).slice(0, 5);
        const tbody = document.getElementById('topServicosBody');
        
        if (sorted.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-message">Nenhum servi√ßo registrado</td></tr>';
        } else {
          tbody.innerHTML = sorted.map(([tipo, dados], i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${tipo}</td>
              <td>${dados.qtd}</td>
              <td class="valor">R$ ${dados.receita.toFixed(2)}</td>
              <td class="trend-up">üìà</td>
            </tr>
          `).join('');
        }

        // Top Produtos
        const produtos = {};
        vendas.forEach(v => {
          const nome = v.produto || 'Produto';
          if (!produtos[nome]) produtos[nome] = { qtd: 0, receita: 0 };
          produtos[nome].qtd += v.quantidade || 1;
          produtos[nome].receita += v.total || v.valor || 0;
        });

        const sortedProd = Object.entries(produtos).sort((a, b) => b[1].qtd - a[1].qtd).slice(0, 5);
        const tbodyProd = document.getElementById('topProdutosBody');
        
        if (sortedProd.length === 0) {
          tbodyProd.innerHTML = '<tr><td colspan="4" class="empty-message">Nenhum produto vendido</td></tr>';
        } else {
          tbodyProd.innerHTML = sortedProd.map(([nome, dados], i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${nome}</td>
              <td>${dados.qtd}</td>
              <td class="valor">R$ ${dados.receita.toFixed(2)}</td>
            </tr>
          `).join('');
        }
      }

      // Inicializar
      renderVendas();
      renderTopServicos();
    </script>
  </body>
</html>
